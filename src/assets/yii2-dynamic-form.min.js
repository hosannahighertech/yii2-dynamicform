!function($){var pluginName="yiiDynamicForm",regexID=/^(.+?)([-\d-]{1,})(.+)$/i,regexName=/(^.+?)([\[\d{1,}\]]{1,})(\[.+\]$)/i,events=($.fn.yiiDynamicForm=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof method&&method?($.error("Method "+method+" does not exist on jQuery.yiiDynamicForm"),!1):methods.init.apply(this,arguments)},{beforeInsert:"beforeInsert",afterInsert:"afterInsert",beforeDelete:"beforeDelete",afterDelete:"afterDelete",limitReached:"limitReached"}),methods={init:function(widgetOptions){return this.each(function(){widgetOptions.template=_parseTemplate(widgetOptions)})},addItem:function(widgetOptions,e,$elem){_addItem(widgetOptions,e,$elem)},deleteItem:function(widgetOptions,e,$elem){_deleteItem(widgetOptions,e,$elem)},updateContainer:function(){var widgetOptions=eval($(this).attr("data-dynamicform"));_updateAttributes(widgetOptions),_restoreSpecialJs(widgetOptions),_fixFormValidaton(widgetOptions)}},_parseTemplate=function(widgetOptions){var $template=$(widgetOptions.template);return $template.find("div[data-dynamicform]").each(function(){var widgetOptions=eval($(this).attr("data-dynamicform")),item;1<$(widgetOptions.widgetItem).length&&(item=$(this).find(widgetOptions.widgetItem).first()[0].outerHTML,$(this).find(widgetOptions.widgetBody).html(item))}),$template.find("input, textarea, select").each(function(){$(this).val("")}),$template.find('input[type="checkbox"], input[type="radio"]').each(function(){var inputName=$(this).attr("name"),inputName=$template.find('input[type="hidden"][name="'+inputName+'"]').first();inputName&&($(this).val(1),inputName.val(0))}),$template},_getWidgetOptionsRoot=function(widgetOptions){return eval($(widgetOptions.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform"))},_getLevel=function($elem){$elem=$elem.parents("div[data-dynamicform]").length;return $elem<0?0:$elem},_count=function($elem,widgetOptions){return $elem.closest("."+widgetOptions.widgetContainer).find(widgetOptions.widgetItem).length},_createIdentifiers=function(level){return new Array(level+2).join("0").split("")},_addItem=function(widgetOptions,e,$elem){_count($elem,widgetOptions)<widgetOptions.limit?($toclone=$(widgetOptions.template),$newclone=$toclone.clone(!1,!1),"top"===widgetOptions.insertPosition?$elem.closest("."+widgetOptions.widgetContainer).find(widgetOptions.widgetBody).prepend($newclone):$elem.closest("."+widgetOptions.widgetContainer).find(widgetOptions.widgetBody).append($newclone),_updateAttributes(widgetOptions),_restoreSpecialJs(widgetOptions),_fixFormValidaton(widgetOptions),$elem.closest("."+widgetOptions.widgetContainer).triggerHandler(events.afterInsert,$newclone)):$elem.closest("."+widgetOptions.widgetContainer).triggerHandler(events.limitReached,widgetOptions.limit)},_removeValidations=function($elem,widgetOptions,count){var level,widgetOptionsRoot,identifiers;1<count&&($elem.find("div[data-dynamicform]").each(function(){for(var currentWidgetOptions=eval($(this).attr("data-dynamicform")),level=_getLevel($(this)),identifiers=_createIdentifiers(level),numItems=$(this).find(currentWidgetOptions.widgetItem).length,i=1;i<=numItems-1;i++){var aux=identifiers;aux[level]=i,currentWidgetOptions.fields.forEach(function(input){input=input.id.replace("{}",aux.join("-"));"undefined"!==$("#"+currentWidgetOptions.formId).yiiActiveForm("find",input)&&$("#"+currentWidgetOptions.formId).yiiActiveForm("remove",input)})}}),level=_getLevel($elem.closest("."+widgetOptions.widgetContainer)),widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions),identifiers=_createIdentifiers(level),identifiers[0]=$(widgetOptionsRoot.widgetItem).length-1,identifiers[level]=count-1,widgetOptions.fields.forEach(function(input){input=input.id.replace("{}",identifiers.join("-"));"undefined"!==$("#"+widgetOptions.formId).yiiActiveForm("find",input)&&$("#"+widgetOptions.formId).yiiActiveForm("remove",input)}))},_deleteItem=function(widgetOptions,e,$elem){var count=_count($elem,widgetOptions);count>widgetOptions.min&&($todelete=$elem.closest(widgetOptions.widgetItem),!1!==$("."+widgetOptions.widgetContainer).triggerHandler(events.beforeDelete,$todelete))&&(_removeValidations($todelete,widgetOptions,count),$todelete.remove(),_updateAttributes(widgetOptions),_restoreSpecialJs(widgetOptions),_fixFormValidaton(widgetOptions),$("."+widgetOptions.widgetContainer).triggerHandler(events.afterDelete))},_updateAttrID=function($elem,index){var widgetOptions=eval($elem.closest("div[data-dynamicform]").attr("data-dynamicform")),id=$elem.attr("id"),newID=id;if(void 0!==id){var matches=id.match(regexID);if(matches&&4===matches.length){matches[2]=matches[2].substring(1,matches[2].length-1);var identifiers=matches[2].split("-");if(identifiers[0]=index,1<identifiers.length){var widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))});for(var widgetsOptions=widgetsOptions.reverse(),i=identifiers.length-1;1<=i;i--)widgetsOptions[i]&&(identifiers[i]=$elem.closest(widgetsOptions[i].widgetItem).index())}newID=matches[1]+"-"+identifiers.join("-")+"-"+matches[3]}else newID=id+index;$elem.attr("id",newID)}return id!==newID&&($elem.closest(widgetOptions.widgetItem).find(".field-"+id).each(function(){$(this).removeClass("field-"+id).addClass("field-"+newID)}),$elem.closest(widgetOptions.widgetItem).find("label[for='"+id+"']").attr("for",newID)),newID},_updateAttrName=function($elem,index){var name=$elem.attr("name");if(void 0!==name){var matches=name.match(regexName);if(matches&&4===matches.length){matches[2]=matches[2].replace(/\]\[/g,"-").replace(/\]|\[/g,"");var identifiers=matches[2].split("-");if(identifiers[0]=index,1<identifiers.length){var widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))});for(var widgetsOptions=widgetsOptions.reverse(),i=identifiers.length-1;1<=i;i--)identifiers[i]=$elem.closest(widgetsOptions[i].widgetItem).index()}name=matches[1]+"["+identifiers.join("][")+"]"+matches[3],$elem.attr("name",name)}}return name},_updateAttributes=function(widgetOptions){widgetOptions=_getWidgetOptionsRoot(widgetOptions);$(widgetOptions.widgetItem).each(function(index){$(this);$(this).find("*").each(function(){_updateAttrID($(this),index),_updateAttrName($(this),index)})})},_fixFormValidatonInput=function(widgetOptions,attribute,id,name){void 0!==attribute&&((attribute=$.extend(!0,{},attribute)).id=id,attribute.container=".field-"+id,attribute.input="#"+id,attribute.name=name,attribute.value=$("#"+id).val(),attribute.status=0,"undefined"!==$("#"+widgetOptions.formId).yiiActiveForm("find",id)&&$("#"+widgetOptions.formId).yiiActiveForm("remove",id),$("#"+widgetOptions.formId).yiiActiveForm("add",attribute))},_fixFormValidaton=function(widgetOptions){var widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions);$(widgetOptionsRoot.widgetBody).find("input, textarea, select").each(function(){var id=$(this).attr("id"),name=$(this).attr("name"),matches,level,identifiers,baseID,attribute;void 0!==id&&void 0!==name&&(currentWidgetOptions=eval($(this).closest("div[data-dynamicform]").attr("data-dynamicform")),matches=id.match(regexID),matches)&&4===matches.length&&(matches[2]=matches[2].substring(1,matches[2].length-1),level=_getLevel($(this)),identifiers=_createIdentifiers(level-1),baseID=matches[1]+"-"+identifiers.join("-")+"-"+matches[3],attribute=$("#"+currentWidgetOptions.formId).yiiActiveForm("find",baseID),_fixFormValidatonInput(currentWidgetOptions,attribute,id,name))})},_restoreKrajeeDepdrop=function($elem){var configDepdrop=$.extend(!0,{},eval($elem.attr("data-krajee-depdrop"))),inputID=$elem.attr("id"),matchID=inputID.match(regexID);if(matchID&&4===matchID.length)for(index=0;index<configDepdrop.depends.length;++index){var match=configDepdrop.depends[index].match(regexID);match&&4===match.length&&(configDepdrop.depends[index]=match[1]+matchID[2]+match[3])}$elem.depdrop(configDepdrop)},_restoreSpecialJs=function(widgetOptions){var widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions),$hasInputmask=$(widgetOptionsRoot.widgetItem).find("[data-plugin-inputmask]"),datePickers=(0<$hasInputmask.length&&$hasInputmask.each(function(){$(this).inputmask("remove"),$(this).inputmask(eval($(this).attr("data-plugin-inputmask")))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-kvdatepicker]")),$hasTimepicker=(datePickers.each(function(index,el){$(this).parent().kvDatepicker(eval($(this).attr("data-krajee-kvdatepicker")))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-timepicker]")),$hasMaskmoney=(0<$hasTimepicker.length&&$hasTimepicker.each(function(){$(this).removeData().off(),$(this).parent().find(".bootstrap-timepicker-widget").remove(),$(this).unbind(),$(this).timepicker(eval($(this).attr("data-krajee-timepicker")))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-maskMoney]")),$hasFileinput=(0<$hasMaskmoney.length&&$hasMaskmoney.each(function(){$(this).parent().find("input").removeData().off();var id="#"+$(this).attr("id"),displayID=id+"-disp";$(displayID).maskMoney("destroy"),$(displayID).maskMoney(eval($(this).attr("data-krajee-maskMoney"))),$(displayID).maskMoney("mask",parseFloat($(id).val())),$(displayID).on("change",function(){var numDecimal=$(displayID).maskMoney("unmasked")[0];$(id).val(numDecimal),$(id).trigger("change")})}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-fileinput]")),$hasTouchSpin=(0<$hasFileinput.length&&$hasFileinput.each(function(){$(this).fileinput(eval($(this).attr("data-krajee-fileinput")))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-TouchSpin]")),$hasSpectrum=(0<$hasTouchSpin.length&&$hasTouchSpin.each(function(){$(this).TouchSpin("destroy"),$(this).TouchSpin(eval($(this).attr("data-krajee-TouchSpin")))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-spectrum]")),$hasDepdrop=(0<$hasSpectrum.length&&$hasSpectrum.each(function(){var id="#"+$(this).attr("id"),sourceID=id+"-source",configSpectrum=($(sourceID).spectrum("destroy"),$(sourceID).unbind(),$(id).unbind(),eval($(this).attr("data-krajee-spectrum")));configSpectrum.change=function(color){jQuery(id).val(color.toString())},$(sourceID).attr("name",$(sourceID).attr("id")),$(sourceID).spectrum(configSpectrum),$(sourceID).spectrum("set",jQuery(id).val()),$(id).on("change",function(){$(sourceID).spectrum("set",jQuery(id).val())})}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-depdrop]")),$hasSelect2=(0<$hasDepdrop.length&&$hasDepdrop.each(function(){void 0===$(this).data("select2")&&($(this).removeData().off(),$(this).unbind(),_restoreKrajeeDepdrop($(this)));var configDepdrop=eval($(this).attr("data-krajee-depdrop"));$(this).depdrop(configDepdrop)}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-select2]")),$hasNumberControl=(0<$hasSelect2.length&&$hasSelect2.each(function(){var id=$(this).attr("id"),configSelect2=eval($(this).attr("data-krajee-select2"));$.when($("#"+id).select2(configSelect2)).done(initS2Loading(id)),$("#"+id).on("select2-open",function(){initSelect2DropStyle(id)}),$(this).attr("data-krajee-depdrop")&&($(this).on("depdrop.beforeChange",function(e,i,v){var configDepdrop=eval($(this).attr("data-krajee-depdrop")),loadingText=configDepdrop.loadingText||"Loading ...";$("#"+id).select2("data",{text:loadingText})}),$(this).on("depdrop.change",function(e,i,v,c){$("#"+id).select2("val",$("#"+id).val())}))}),$(widgetOptionsRoot.widgetItem).find("[data-krajee-numbercontrol]"));0<$hasNumberControl.length&&$hasNumberControl.each(function(){var configNumberControl=eval($(this).attr("data-krajee-numbercontrol"));configNumberControl.displayId=$(this).parent().prev().attr("id"),$(this).data("numberControl")&&$(this).numberControl("destroy"),$(this).numberControl(configNumberControl)})}}(window.jQuery);